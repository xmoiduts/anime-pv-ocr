# task_resolver.py contains task-specific hardcoded logics,
# when defining a new task, you need to optionally add processor logic to it.

pipeline:
  all:
    # media -> spotter -> hard-samples -> ocr-filtered
    tasks:
      - spotter
      - dig-hard-samples
      - ocr-filtered
  no-hard-samples:
    # run only the initial spotting step
    tasks:
      - spotter
      - ocr-filtered

task:
  scene-detector:
    # ad-hoc, result not promising.
    model: gemini-2.5-flash-lite
    prompt_file: prompts/scene/gemini-scene-detector.md
    media_resolution: MEDIA_RESOLUTION_MEDIUM # Medium: 256 tokens per image
    # thinking_level: medium # 2.5 flash lite does not support thinking level yet
    grid_rows: 2
    grid_cols: 2
    media_dir: medias
    output_dir: outputs

  spotter:
    # key task, a bare multimedia input meets this task first.
    model: gemini-3-flash-preview
    prompt_file: prompts/spotter/gemini-subtitle-spotter.md
    media_resolution: MEDIA_RESOLUTION_HIGH
    # media_resolution: specify the resolution of all images passed to "spotter"
    # for gemini 3 series, value range: `MEDIA_RESOLUTION_(LOW|MEDIUM|HIGH|ULTRA_HIGH|UNSPECIFIED)`
    #thinking_level: medium
    # thinking_level: specify the thinking level of the "spotter"
    # gemini 3 series: {minimal, low, medium, high}
    #   flash: {minimal, low, medium, high}; pro: {low, high}
    grid_rows: 4
    grid_cols: 3
    media_dir: medias
    output_dir: outputs
    #base_url: https://your-custom-proxy.com

  dig-hard-samples:
    # Optional task, placed after spotter to dig out hard samples (small or low-contrast texts).
    # Filters out spotter-selected frames that are likely to be easy to OCR,
    #   and digs from the rest of frames.
    model: gemini-3-flash-preview
    prompt_file: prompts/spotter/gemini-small-subtitle-spotter.md # Specialized prompt for small subtitles
    stripping: 5
    grid_rows: 5
    image_width: 1280
    media_resolution: MEDIA_RESOLUTION_MEDIUM # single full frame is enough in 550 tokens, so medium is enough
    media_dir: medias
    output_dir: outputs
    # avoid frames before and after the spotter-selected frames.
    avoid_before: 3
    avoid_after: 2

  ocr-filtered:
    # Key task, actually does the OCR.
    model: gemini-3-flash-preview
    prompt_file: prompts/ocr/gemini-ocr-filtered.md
    media_resolution: MEDIA_RESOLUTION_MEDIUM
    # 1 frame per uploaded file.
    enable_audio: true
    media_dir: medias
    output_dir: outputs

  adhoc-ask-clarity: # ask models: under this prompt, can you see any subtitle section that worth you report positive?
    model: gemini-3-flash-preview
    prompt_file: prompts/adhoc/pyramid-ask-clarity.md # Default to spotter prompt if none given
    spotter_prompt_file: prompts/spotter/gemini-subtitle-spotter.md
    media_resolution: MEDIA_RESOLUTION_HIGH
    folder: outputs/<media_name>/pyramid_712_3x4


# Post-run behavior and pricing defaults
runtime:
  idle_exit_seconds: 30 # Countdown before exit if no follow-up is entered
  enable_post_run_chat: true

# Pricing moved to per-model sections below
# pricing:
#   default_input_per_million: 0.10
#   default_output_per_million: 0.40

fee:
  exchange_rate: 7.2

model:
  gemini-3-pro-preview:
    gemini-generation: 3
    price:
      input: 2.00
      output: 12.00
  gemini-3-flash-preview:
    gemini-generation: 3
    # thinking_level: {minimal, low, medium, high}
    # media_resolution: MEDIA_RESOLUTION_(LOW|MEDIUM|HIGH|ULTRA_HIGH|UNSPECIFIED)
    #   for every image:{low: 280, medium: 560, high: 1120, ultra_high: 2240}
    #   unspecified.image defaults to 560 tokens/img,
    #   ultra_high are for per-part only
    price:
      input: 0.50
      output: 3.00
  gemini-2.5-flash-lite:
    gemini-generation: 2.5
    price:
      input: 0.10
      output: 0.40
    # thinking_budget: {auto:-1, off:0, yes: "512-24576"}
    # no thinking_level for gen 2.5
